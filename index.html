<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpendZ - Login</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@500;600;700;800&family=Poppins:wght@600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Link to the fresh CSS -->
    <link rel="stylesheet" href="style.css?v=6">

    <!-- Supabase SDK (Crucial for Database) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>
</head>

<body>
    <div class="wrapper">
        <!-- Visual Brand Side -->
        <div class="visual-side">
            <div class="visual-mesh"></div>
            <div class="visual-content">
                <h1 class="brand-title">SpendZ</h1>
                <p class="brand-tagline">Master your college finances.</p>
            </div>
        </div>

        <!-- Login Form Side -->
        <div class="login-side">
            <div class="login-container">
                <div class="welcome-text">
                    <h2>Welcome Back</h2>
                    <p>Enter your details to access your dashboard.</p>
                </div>


                <!-- Google Sign In Button -->
                <button class="btn btn-google" id="googleBtn" onclick="tryGoogleLogin()">
                    <img src="https://www.svgrepo.com/show/475656/google-color.svg" alt="Google"
                        style="width: 20px; height: 20px;">
                    Continue with Google
                </button>

                <div class="divider">
                    <span>OR CONTINUE WITH EMAIL</span>
                </div>

                <!-- Email Input -->
                <div class="mb-4">
                    <label class="form-label">Email Address</label>
                    <input type="email" id="emailInput" class="form-input" placeholder="name@university.edu"
                        autocomplete="email">
                </div>

                <!-- Error Message for Email -->
                <div id="emailError" class="error-message">
                    <i class="fa-solid fa-circle-exclamation"></i> <span id="emailErrorText">Please enter a valid email
                        address.</span>
                </div>

                <!-- Password Input with Toggle -->
                <div class="mb-4">
                    <label class="form-label">Password</label>
                    <div style="position: relative;">
                        <input type="password" id="passwordInput" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            autocomplete="current-password" style="padding-right: 45px;">
                        <button type="button" onclick="togglePasswordVisibility()"
                            style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-gray); cursor: pointer; padding: 5px;">
                            <i class="fa-solid fa-eye" id="togglePasswordIcon"></i>
                        </button>
                    </div>
                </div>

                <!-- General Error Message -->
                <div id="generalError" class="error-message" style="display: none; margin-bottom: 15px;">
                    <i class="fa-solid fa-circle-exclamation"></i> <span id="generalErrorText"></span>
                </div>

                <!-- Sign In Button -->
                <button class="btn btn-primary" id="signInBtn" onclick="handleDirectLogin()">
                    Sign In
                </button>

                <!-- Sign Up Link -->
                <p style="margin-top: 1.5rem; text-align: center; color: var(--text-muted); font-size: 0.9rem;">
                    Don't have an account? <a href="#" onclick="toggleSignUp()"
                        style="color: var(--primary); text-decoration: none; font-weight: 500;">Sign up for free</a>
                </p>
            </div>
        </div>
    </div>

    <script>
        // Check if already logged in
        async function checkSession() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                window.location.replace('dashboard.html');
            }
        }
        checkSession();

        // login Function (Demo User Flow) - DEBUG VERSION
        async function tryGoogleLogin() {
            const btn = document.getElementById('googleBtn');
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Connecting...';
            btn.disabled = true;

            console.log('=== LOGIN START ===');

            try {
                const email = 'demo@spendz.com';
                const password = 'password123';

                // 1. Try to Login
                console.log('Step 1: Trying to login...');
                let result = await supabase.auth.signInWithPassword({
                    email,
                    password
                });

                console.log('Login result:', {
                    hasSession: !!result.data?.session,
                    hasUser: !!result.data?.user,
                    errorMsg: result.error?.message
                });

                // 2. If User Not Found, Create Account
                if (result.error) {
                    console.log('Step 2: Login failed, creating account...');
                    console.log('Error was:', result.error.message);

                    const signUpResult = await supabase.auth.signUp({
                        email,
                        password,
                        options: { data: { full_name: 'Demo User' } }
                    });

                    console.log('Signup result:', {
                        hasSession: !!signUpResult.data?.session,
                        hasUser: !!signUpResult.data?.user,
                        errorMsg: signUpResult.error?.message
                    });

                    if (signUpResult.error) {
                        console.error('Signup failed:', signUpResult.error);
                        throw signUpResult.error;
                    }

                    // Check if we got a session
                    if (signUpResult.data.session) {
                        console.log('‚úÖ Got session from signup!');
                        result = signUpResult;
                    } else if (signUpResult.data.user && !signUpResult.data.session) {
                        console.error('‚ö†Ô∏è User created but NO SESSION!');
                        console.error('This means email confirmation is STILL ON');
                        alert('Email confirmation is STILL enabled in Supabase!\n\nDouble check:\nAuthentication > Providers > Email > "Confirm email" = OFF');
                        btn.innerHTML = '<img src="https://www.svgrepo.com/show/475656/google-color.svg" style="width: 20px; height: 20px;"> Continue with Google';
                        btn.disabled = false;
                        return;
                    } else {
                        console.log('Step 3: Retrying login...');
                        result = await supabase.auth.signInWithPassword({ email, password });
                        console.log('Retry result:', {
                            hasSession: !!result.data?.session,
                            errorMsg: result.error?.message
                        });
                    }
                }

                if (result.error) {
                    console.error('Final error:', result.error);
                    throw result.error;
                }

                if (!result.data.session) {
                    console.error('‚ùå NO SESSION in final result!');
                    throw new Error('No session - check Supabase email confirmation settings');
                }

                console.log('‚úÖ SUCCESS! Redirecting...');
                console.log('Session user ID:', result.data.session.user.id);
                console.log('=== LOGIN END ===');

                localStorage.setItem('spendzLoggedIn', 'true');
                window.location.href = 'dashboard.html';

            } catch (err) {
                console.error("‚ùå LOGIN FAILED:", err);
                btn.innerHTML = '<img src="https://www.svgrepo.com/show/475656/google-color.svg" style="width: 20px; height: 20px;"> Continue with Google';
                btn.disabled = false;
                alert('Login failed: ' + err.message + '\n\nOpen console (F12) for details');
            }
        }


        async function handleDirectLogin() {
            const emailInput = document.getElementById('emailInput');
            const passwordInput = document.getElementById('passwordInput');
            const btn = document.getElementById('signInBtn');

            // Hide previous errors
            hideErrors();

            // Validate Email
            const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            if (!emailInput.value || !re.test(String(emailInput.value).toLowerCase())) {
                showError('Please enter a valid email address.');
                emailInput.style.borderColor = '#ef4444';
                emailInput.focus();
                return;
            }

            // Validate Password
            if (passwordInput.value.length < 6) {
                showError('Password must be at least 6 characters.', true);
                passwordInput.style.borderColor = '#ef4444';
                passwordInput.focus();
                return;
            }

            // Show loading state
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Authenticating...';
            btn.disabled = true;

            try {
                const email = emailInput.value;
                const password = passwordInput.value;

                console.log('üîê Manual login attempt:', email);

                // Try to login
                let result = await supabase.auth.signInWithPassword({
                    email,
                    password
                });

                console.log('Login result:', {
                    hasSession: !!result.data?.session,
                    error: result.error?.message
                });

                // If user doesn't exist, create account
                if (result.error && result.error.message.includes('Invalid login')) {
                    console.log('User not found, creating account...');

                    const signUpResult = await supabase.auth.signUp({
                        email,
                        password,
                        options: { data: { full_name: email.split('@')[0] } }
                    });

                    if (signUpResult.error) throw signUpResult.error;

                    if (signUpResult.data.session) {
                        result = signUpResult;
                    } else {
                        showError('Account created! Please check your email to confirm.', true);
                        btn.innerHTML = btn.innerText.includes('Sign Up') ? 'Sign Up' : 'Sign In';
                        btn.disabled = false;
                        return;
                    }
                }

                if (result.error) throw result.error;

                if (!result.data.session) {
                    throw new Error('Authentication failed. Please try again.');
                }

                console.log('‚úÖ Login successful!');
                localStorage.setItem('spendzLoggedIn', 'true');

                // Success animation
                btn.innerHTML = '<i class="fa-solid fa-check"></i> Success!';
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 500);

            } catch (err) {
                console.error('‚ùå Login failed:', err);
                btn.innerHTML = btn.innerText.includes('Sign Up') ? 'Sign Up' : 'Sign In';
                btn.disabled = false;

                // User-friendly error messages
                let errorMessage = 'Login failed. Please try again.';
                if (err.message.includes('Email not confirmed')) {
                    errorMessage = 'Please confirm your email address first.';
                } else if (err.message.includes('Invalid')) {
                    errorMessage = 'Invalid email or password.';
                } else if (err.message) {
                    errorMessage = err.message;
                }

                showError(errorMessage, true);
            }
        }


        function toggleSignUp() {
            const title = document.querySelector('.welcome-text h2');
            const subtitle = document.querySelector('.welcome-text p');
            const btn = document.querySelector('#signInBtn');
            const link = document.querySelector('p a');

            if (btn.innerText === 'Sign In') {
                title.innerText = 'Create Account';
                subtitle.innerText = 'Join the club & start tracking.';
                btn.innerText = 'Sign Up';
                link.innerText = 'Already have an account? Login';
            } else {
                title.innerText = 'Welcome Back';
                subtitle.innerText = 'Enter your details to access your dashboard.';
                btn.innerText = 'Sign In';
                link.innerText = 'Sign up for free';
            }
        }

        // Password visibility toggle
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('passwordInput');
            const toggleIcon = document.getElementById('togglePasswordIcon');

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }

        // Show error message
        function showError(message, isGeneral = false) {
            if (isGeneral) {
                const generalError = document.getElementById('generalError');
                const generalErrorText = document.getElementById('generalErrorText');
                generalErrorText.textContent = message;
                generalError.style.display = 'flex';
            } else {
                const emailError = document.getElementById('emailError');
                const emailErrorText = document.getElementById('emailErrorText');
                emailErrorText.textContent = message;
                emailError.style.display = 'flex';
            }
        }

        // Hide all errors
        function hideErrors() {
            document.getElementById('emailError').style.display = 'none';
            document.getElementById('generalError').style.display = 'none';
            document.getElementById('emailInput').style.borderColor = 'rgba(255,255,255,0.1)';
            document.getElementById('passwordInput').style.borderColor = 'rgba(255,255,255,0.1)';
        }

        // Clear errors on typing
        document.getElementById('emailInput').addEventListener('input', hideErrors);
        document.getElementById('passwordInput').addEventListener('input', hideErrors);

        // Enter key to submit
        document.getElementById('passwordInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                handleDirectLogin();
            }
        });
    </script>
</body>

</html>